<div class="max-w-7xl mx-auto">
  <div class="flex items-center mb-6">
    <button (click)="goBack()" class="mr-4 p-2 rounded-full hover:bg-slate-200 transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
    </button>
    <div>
      <h1 class="text-3xl font-bold">Level {{ level().id }}: {{ level().title }}</h1>
      <p class="text-slate-600">{{ level().description }}</p>
    </div>
  </div>

  <div class="flex flex-col md:flex-row gap-8">
    <!-- Sidebar Navigation -->
    <aside class="w-full md:w-56 flex-shrink-0">
      <div class="bg-slate-100 rounded-lg p-3 space-y-2">
        @for (skill of skills; track skill) {
          <button 
            (click)="selectSkill(skill)"
            [class.bg-gradient-to-r]="selectedSkill() === skill"
            [class.from-indigo-50]="selectedSkill() === skill"
            [class.to-purple-50]="selectedSkill() === skill"
            [class.text-indigo-600]="selectedSkill() === skill"
            [class.shadow]="selectedSkill() === skill"
            class="w-full text-left px-4 py-2.5 rounded-md font-semibold transition-all duration-200 text-slate-700 hover:bg-white">
            {{ 'skill.' + skill | translate }}
          </button>
        }
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow bg-white rounded-xl shadow-lg p-6 min-h-[500px]">
      @if (selectedSkill() === 'Vocabulary') {
        <app-vocabulary-trainer [level]="level()"></app-vocabulary-trainer>
      } @else if (isLoading() && !assessmentState().isComplete && !listeningQuizState().isComplete) {
        <div class="flex flex-col items-center justify-center h-full text-center text-slate-500">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
          <p class="font-semibold">{{ 'level.generating' | translate: {skill: selectedSkill()} }}</p>
          <p class="text-sm">{{ 'level.aiThinking' | translate }}</p>
        </div>
      } @else {
        @switch (content()?.type) {
          @case ('markdown') {
            <div [innerHTML]="parsedMarkdown()" class="prose max-w-none"></div>
          }
          @case ('game') { <!-- This case is for Assessment questions -->
             @if (assessmentState().isComplete) {
                <div class="p-4" id="assessment-results">
                  <div class="text-center mb-6">
                      <h2 class="text-3xl font-bold text-green-600">{{ 'assessment.complete' | translate }}</h2>
                      <p class="text-xl text-slate-700 mt-2">{{ 'assessment.score' | translate: {correct: assessmentState().correctAnswers, total: ASSESSMENT_LENGTH} }}</p>
                  </div>

                  <div class="my-4">
                    <h3 class="text-lg font-semibold mb-2">{{ 'assessment.review' | translate }}</h3>
                    <div class="overflow-x-auto border border-slate-200 rounded-lg max-h-96">
                      <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0">
                          <tr>
                            <th scope="col" class="px-6 py-3">{{ 'assessment.table.question' | translate }}</th>
                            <th scope="col" class="px-6 py-3">{{ 'assessment.table.yourAnswer' | translate }}</th>
                            <th scope="col" class="px-6 py-3">{{ 'assessment.table.correctAnswer' | translate }}</th>
                            <th scope="col" class="px-6 py-3">{{ 'assessment.table.status' | translate }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (result of assessmentState().results; track $index) {
                            <tr class="bg-white border-b" [class.bg-red-50]="!result.isCorrect">
                              <td class="px-6 py-4 font-medium text-slate-900">{{ result.question.sentence.replace('___', '...') }}</td>
                              <td class="px-6 py-4" [class.text-red-600]="!result.isCorrect">{{ result.userAnswer }}</td>
                              <td class="px-6 py-4 font-bold text-green-600">{{ result.question.correctAnswer }}</td>
                              <td class="px-6 py-4">
                                @if (result.isCorrect) {
                                  <span class="text-green-600 font-semibold">{{ 'assessment.status.correct' | translate }}</span>
                                } @else {
                                  <span class="text-red-600 font-semibold">{{ 'assessment.status.incorrect' | translate }}</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="mt-6 flex gap-4">
                  <button (click)="selectSkill('Assessment')" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    {{ 'level.tryAgain' | translate }}
                  </button>
                </div>
              } @else if (assessmentQuestion(); as question) {
                <div class="space-y-6">
                <div class="text-center text-sm font-semibold text-slate-500">
                  {{ 'assessment.progress' | translate: {current: assessmentState().questionsAnswered + 1, total: ASSESSMENT_LENGTH} }}
                </div>
                <div>
                  <p class="text-sm text-slate-500 mb-2 font-semibold">{{ 'level.fillBlank' | translate }}</p>
                  <p class="text-2xl text-slate-800 bg-slate-100 p-4 rounded-lg">{{ question.sentence }}</p>
                </div>
                <div class="grid grid-cols-1 gap-3">
                  @for (option of question.options; track option) {
                    <button
                      (click)="handleAssessmentAnswer(option)"
                      [disabled]="!!userSelection()"
                      [class.bg-green-100]="userSelection()?.isCorrect && userSelection()?.answer === option"
                      [class.border-green-500]="userSelection()?.isCorrect && userSelection()?.answer === option"
                      [class.text-green-800]="userSelection()?.isCorrect && userSelection()?.answer === option"
                      [class.bg-red-100]="!userSelection()?.isCorrect && userSelection()?.answer === option"
                      [class.border-red-500]="!userSelection()?.isCorrect && userSelection()?.answer === option"
                      [class.text-red-800]="!userSelection()?.isCorrect && userSelection()?.answer === option"
                      [class.hover:bg-indigo-50]="!userSelection()"
                      class="w-full text-left p-4 border-2 border-slate-200 rounded-lg text-lg font-medium transition-all disabled:cursor-not-allowed">
                      {{ option }}
                    </button>
                  }
                </div>
                @if (userSelection(); as selection) {
                  <div class="p-4 rounded-lg" [class.bg-green-50]="selection.isCorrect" [class.bg-red-50]="!selection.isCorrect">
                    <h3 class="font-bold text-lg" [class.text-green-800]="selection.isCorrect" [class.text-red-800]="!selection.isCorrect">
                      {{ selection.isCorrect ? ('level.correct' | translate) : ('level.notQuite' | translate) }}
                    </h3>
                    @if (!selection.isCorrect) {
                      <p class="text-red-700 mt-1">{{ 'level.correctAnswerIs' | translate }} <strong>{{ question.correctAnswer }}</strong></p>
                    }
                    <p class="text-slate-600 mt-2">
                      <span class="font-semibold">{{ question.sentence.replace('___', question.correctAnswer) }}</span>
                      <br>
                      <span class="text-sm">({{ question.translation }})</span>
                    </p>
                  </div>
                }
              </div>
              }
          }
          @case ('speaking') {
            @if (speakingExercise(); as exercise) {
            <div class="space-y-6">
              @if (speakingStatus() === 'idle' || speakingStatus() === 'listening') {
                <div>
                  <p class="text-sm text-slate-500 mb-2 font-semibold">{{ 'level.readAloud' | translate }}</p>
                  <div class="text-2xl text-slate-800 bg-slate-100 p-6 rounded-lg text-center">
                    <p>"{{ exercise.sentence }}"</p>
                    <p class="text-base text-slate-500 mt-2">({{ exercise.translation }})</p>
                  </div>
                </div>
                <div class="flex flex-col items-center justify-center pt-4">
                  <button (click)="toggleListen()" class="w-20 h-20 rounded-full flex items-center justify-center transition-all duration-300"
                    [class.bg-indigo-600]="speakingStatus() === 'idle'"
                    [class.hover:bg-indigo-700]="speakingStatus() === 'idle'"
                    [class.bg-red-600]="speakingStatus() === 'listening'">
                      <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                  </button>
                  <p class="text-sm text-slate-500 mt-3 h-5 text-center">
                    @if (speakingStatus() === 'idle') { <span>{{ 'level.clickMic' | translate }}</span> }
                    @if (speakingStatus() === 'listening') { <span class="text-red-600 font-semibold">{{ 'level.listening' | translate }}</span> }
                  </p>
                </div>
              }
              @if (speakingStatus() === 'processing') {
                <div class="flex flex-col items-center justify-center h-full text-center text-slate-500 py-10">
                  <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
                  <p class="font-semibold">{{ 'level.analyzing' | translate }}</p>
                  <p class="text-sm">{{ 'level.youSaid' | translate }} "{{ userTranscript() }}"</p>
                </div>
              }
              @if (speakingStatus() === 'feedback' && pronunciationFeedback(); as feedback) {
                <div class="space-y-4">
                  <div class="p-4 rounded-lg" [class.bg-green-50]="feedback.score >= 80" [class.bg-yellow-50]="feedback.score >= 50 && feedback.score < 80" [class.bg-red-50]="feedback.score < 50">
                    <h3 class="font-bold text-xl" [class.text-green-800]="feedback.score >= 80" [class.text-yellow-800]="feedback.score >= 50 && feedback.score < 80" [class.text-red-800]="feedback.score < 50">
                      {{ feedback.overallComment }} (Score: {{ feedback.score }}/100)
                    </h3>
                  </div>
                  
                  <div>
                    <p class="text-sm text-slate-500 font-semibold mb-2">{{ 'level.wordAnalysis' | translate }}</p>
                    <div class="p-4 bg-slate-100 rounded-md">
                        <div class="flex flex-wrap items-end justify-center gap-x-4 gap-y-4">
                            @for (word of feedback.analyzedWords; track $index) {
                                <div class="flex flex-col text-center">
                                    @if(word.status === 'correct') {
                                        <span class="text-2xl text-slate-800 px-1">{{ word.word }}</span>
                                        <div class="h-5 flex justify-center items-center mt-1 text-green-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                    } @else { <!-- incorrect or mispronounced -->
                                        <span class="text-2xl p-1 rounded bg-red-100 text-red-800">
                                            {{ word.word }}
                                        </span>
                                        @if (word.comment || word.improvementSuggestion) {
                                            <span class="text-sm font-medium text-red-700 mt-1">{{ word.comment || word.improvementSuggestion }}</span>
                                        } @else {
                                            <div class="h-5 mt-1"></div> <!-- Placeholder for alignment -->
                                        }
                                    }
                                </div>
                            }
                        </div>
                    </div>
                  </div>

                  <div>
                    <p class="text-sm text-slate-500 font-semibold mb-1">{{ 'level.youSaid' | translate }}</p>
                    <p class="p-3 bg-slate-100 rounded-md text-slate-800">{{ userTranscript() || ('level.noSpeech' | translate) }}</p>
                  </div>

                  <div class="flex space-x-4 pt-4">
                    <button (click)="tryAgainSpeaking()" class="flex-1 bg-slate-200 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-300 transition-colors">
                      {{ 'level.tryAgain' | translate }}
                    </button>
                    <button (click)="loadNewSentence()" class="flex-1 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                      {{ 'level.newSentence' | translate }}
                    </button>
                  </div>
                </div>
              }
            </div>
            }
          }
          @case('listening') {
            @if (listeningQuizState().isComplete) {
              <div class="p-4" id="listening-results">
                <div class="text-center mb-6">
                    <h2 class="text-3xl font-bold text-green-600">{{ 'listening.complete' | translate }}</h2>
                    <p class="text-xl text-slate-700 mt-2">{{ 'assessment.score' | translate: {correct: listeningQuizState().correctAnswers, total: LISTENING_QUIZ_LENGTH} }}</p>
                </div>
                <div class="my-4">
                  <h3 class="text-lg font-semibold mb-2">{{ 'assessment.review' | translate }}</h3>
                  <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                    @for(result of listeningQuizState().results; track $index) {
                      <div class="border rounded-lg p-4" [class.bg-red-50]="!result.isCorrect" [class.border-red-200]="!result.isCorrect">
                        <p class="font-semibold text-slate-800">{{ result.question.question }}</p>
                        <p class="text-sm text-slate-500 italic mb-2">"{{ result.question.questionTranslation }}"</p>
                        <div class="flex justify-between items-center mt-2">
                          <div>
                            <span class="text-xs font-semibold text-slate-500 uppercase">{{ 'assessment.table.yourAnswer' | translate }}</span>
                            <p [class.text-red-600]="!result.isCorrect" [class.text-green-600]="result.isCorrect">{{ result.userAnswer }}</p>
                            <p class="text-sm text-slate-500 italic">"{{ getOptionTranslation(result.question, result.userAnswer) }}"</p>
                          </div>
                          @if (!result.isCorrect) {
                            <div>
                              <span class="text-xs font-semibold text-slate-500 uppercase">{{ 'assessment.table.correctAnswer' | translate }}</span>
                              <p class="text-green-700 font-bold">{{ result.question.correctAnswer }}</p>
                              <p class="text-sm text-slate-500 italic">"{{ getOptionTranslation(result.question, result.question.correctAnswer) }}"</p>
                            </div>
                          }
                          <div>
                            @if (result.isCorrect) {
                                <span class="text-green-600 font-semibold flex items-center gap-1">
                                  <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                                  {{ 'assessment.status.correct' | translate }}
                                </span>
                            } @else {
                                <span class="text-red-600 font-semibold flex items-center gap-1">
                                   <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                  {{ 'assessment.status.incorrect' | translate }}
                                </span>
                            }
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </div>
                <div class="mt-6">
                  <button (click)="selectSkill('Listening')" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                    {{ 'level.tryAgain' | translate }}
                  </button>
                </div>
              </div>
            } @else if(listeningExercise(); as exercise) {
              <div class="space-y-6">
                <div>
                   <div class="flex justify-between items-baseline mb-2">
                      <p class="text-sm text-slate-500 font-semibold">{{ 'skill.Listening' | translate }}:</p>
                      <div class="text-sm font-semibold text-slate-500">
                          {{ 'assessment.progress' | translate: {current: listeningQuizState().questionsAnswered + 1, total: LISTENING_QUIZ_LENGTH} }}
                      </div>
                  </div>
                  <div class="p-4 bg-slate-100 rounded-lg">
                    <div class="flex items-center gap-4">
                      <button (click)="playListeningScript()" [disabled]="audioStatus() === 'playing'" class="w-14 h-14 bg-indigo-600 text-white rounded-full flex items-center justify-center disabled:bg-slate-400 hover:bg-indigo-700 transition-colors flex-shrink-0">
                        @if (audioStatus() === 'playing') {
                           <svg class="w-6 h-6 animate-pulse" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M3 5h4v14H3V5zm14 0h4v14h-4V5zm-7 0h4v14h-4V5z"/></svg>
                        } @else {
                           <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                        }
                      </button>
                      <button (click)="showListeningTranslation.set(true)" [disabled]="showListeningTranslation()" class="px-4 py-2 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 disabled:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">Translate</button>
                    </div>
                     @if(showListeningTranslation()) {
                       <p class="text-slate-600 italic mt-3 pt-3 border-t border-slate-300">"{{ exercise.translation }}"</p>
                     }
                  </div>
                </div>

                <div class="border-t pt-6">
                  <p class="text-sm text-slate-500 mb-2 font-semibold">Frage (Question):</p>
                  <p class="text-xl text-slate-800">{{ exercise.question }}</p>
                </div>
                <div class="grid grid-cols-1 gap-3">
                  @for (option of exercise.options; track option) {
                    <button (click)="handleListeningAnswer(option)" [disabled]="!!listeningUserSelection()"
                      [class.bg-green-100]="listeningUserSelection()?.isCorrect && listeningUserSelection()?.answer === option"
                      [class.border-green-500]="listeningUserSelection()?.isCorrect && listeningUserSelection()?.answer === option"
                      [class.text-green-800]="listeningUserSelection()?.isCorrect && listeningUserSelection()?.answer === option"
                      [class.bg-red-100]="!listeningUserSelection()?.isCorrect && listeningUserSelection()?.answer === option"
                      [class.border-red-500]="!listeningUserSelection()?.isCorrect && listeningUserSelection()?.answer === option"
                      [class.text-red-800]="!listeningUserSelection()?.isCorrect && listeningUserSelection()?.answer === option"
                      [class.hover:bg-indigo-50]="!listeningUserSelection()"
                      class="w-full text-left p-4 border-2 border-slate-200 rounded-lg text-lg font-medium transition-all disabled:cursor-not-allowed">
                      {{ option }}
                    </button>
                  }
                </div>
                @if (listeningUserSelection(); as selection) {
                  <div class="p-4 rounded-lg" [class.bg-green-50]="selection.isCorrect" [class.bg-red-50]="!selection.isCorrect">
                    <h3 class="font-bold text-lg" [class.text-green-800]="selection.isCorrect" [class.text-red-800]="!selection.isCorrect">
                      {{ selection.isCorrect ? ('level.correct' | translate) : ('level.notQuite' | translate) }}
                    </h3>
                    @if (!selection.isCorrect) {
                      <p class="text-red-700 mt-1">{{ 'level.correctAnswerIs' | translate }} <strong>{{ exercise.correctAnswer }}</strong></p>
                    }
                  </div>
                }
              </div>
            }
          }
          @default {
            <div class="text-center text-slate-500 py-12">
              <p>{{ 'level.loadError' | translate }}</p>
            </div>
          }
        }
      }
    </main>
  </div>
</div>